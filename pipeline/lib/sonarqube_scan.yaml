stages:
  - code

sonarqube-report:
  stage: code
  allow_failure: true
  image:
    name: sonarqube-scanner:latest
    entrypoint: [""]
  tags:
    - aws
    - m4-large
  variables:
    SONAR_SOURCES: "server/src,frontend/src"
    SONAR_ANALYSIS_MODE: publish
    SONAR_SCANNER_OPTS: "-Xmx8192m"
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar" # Defines the location of the analysis task cache
    GIT_DEPTH: "0" # Tells git to fetch all the branches of the project, required by the analysis task
    SONAR_PROJECT_VERSION: $CI_BUILD_ID
    SONAR_JS_LCOV_REPORT_PATHS: "server/coverage/lcov.info,frontend/coverage/lcov.info"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner

create_report_status:
  stage: code
  allow_failure: true
  image: node:22.12.0-slim
  tags:
    - m4-large
    - aws
  script:
    - echo "Upload Report Frontend UT / Backend UT and Quality Gate for ${CI_PROJECT_NAME} [${CI_PROJECT_ID}]"
    - cd devops_index
    - npm i
    - npm start
    #- 'curl --request PUT --upload-file "${CI_PROJECT_ID}_quality_gate.json" "https://swpc-jira-add-on-storage-5f24a578-086c-430f-b282-598bbb54a7b6.s3-ap-northeast-1.amazonaws.com/" -H "x-amz-acl: public-read" -H "Content-Type: application/json"'
  dependencies:
    - "sonarqube-report"
  artifacts:
    paths:
      - "devops_index/${CI_PROJECT_ID}_*.json"
    expire_in: 1 weeks
